<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>实时对话系统</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style_app.css') }}">
</head>

<body>
    <a class="back-home" href="/">← 返回主界面</a>
    <div class="main-content" style="position:relative;min-height:600px;">
        <div class="left-preview">
            <div class="audio-box" style="margin-bottom: 12px;">
                <audio id="previewAudio" class="preview-audio" controls style="width:100%;"></audio>
            </div>
            <div class="video-box">
                <video id="previewVideo" class="preview-video" controls loop muted style="width:100%; height:auto; background:#000;"></video>
            </div>
        </div>
        <div class="right-form">
            <form method="POST">
                <div class="form-group">
                    <label>模型名称</label>
                    <p style="margin:6px 0;">Voice Persona</p>
                </div>

                <div class="form-group">
                    <label>目标演讲者</label>
                    <select id="targetSpeaker"></select>
                </div>

                <div class="form-group">
                    <label>对话</label>
                    <div class="chat-section" style="display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center;">
                        <input type="text" id="chatInput" placeholder="请输入您的消息..." style="width:100%; padding:8px; border-radius:4px; border:1px solid #ccc;">
                        <button type="button" id="sendChatBtn" class="submit-btn" style="padding:8px 12px; min-width:64px;">发送</button>
                    </div>
                    <div id="chatMessages" style="margin-top: 8px; height: 160px; overflow-y:auto; border: 1px solid #ccc; padding: 10px; background: #f9f9f9; border-radius: 4px;"></div>
                </div>

                <div class="form-group">
                    <label>合成文本（使用最近一次 AI 回复）</label>
                    <textarea id="synthesisText" rows="3" placeholder="在此粘贴要合成的文本..." style="width:100%;"></textarea>
                </div>

                <div class="form-group">
                    <div style="margin-top: 8px; margin-bottom: 16px;">
                        <button type="button" id="generateAudioBtn" class="submit-btn" style="width:100%;">生成音频</button>
                    </div>
                    <label>输出音频地址</label>
                    <input type="text" id="outputWavePath" placeholder="例如：/media/output/YYMMDD_HHMMSS_output.wav">
                </div>

                <div class="form-group">
                    <label>输出视频地址</label>
                    <input type="text" id="outputVideoPath" placeholder="例如：/media/asset/Obama.mp4 或 /media/output/result.mp4">
                    <div style="margin-top: 8px; display:flex; gap:8px;">
                        <button type="button" id="generateVideoBtn" class="submit-btn" style="flex:1;">生成视频</button>
                        <button type="button" id="playVideoBtn" class="submit-btn" style="flex:1;">播放视频</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        (function() {
            const previewAudio = document.getElementById('previewAudio');
            const previewVideo = document.getElementById('previewVideo');
            const targetSpeakerEl = document.getElementById('targetSpeaker');
            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const sendChatBtn = document.getElementById('sendChatBtn');
            const synthesisTextEl = document.getElementById('synthesisText');
            const outputWavePathEl = document.getElementById('outputWavePath');
            const outputVideoPathEl = document.getElementById('outputVideoPath');
            const generateAudioBtn = document.getElementById('generateAudioBtn');
            const generateVideoBtn = document.getElementById('generateVideoBtn');
            const playVideoBtn = document.getElementById('playVideoBtn');

            let speakerProfiles = null;
            let lastAiReply = '';
            let hasGeneratedVideo = false; // switch to /media/output/result.mp4 after generation

            function appendMessage(sender, text) {
                const messageEl = document.createElement('div');
                messageEl.style.marginBottom = '8px';
                messageEl.style.padding = '6px 10px';
                messageEl.style.borderRadius = '8px';
                messageEl.style.maxWidth = '80%';
                if (sender === 'user') { messageEl.style.backgroundColor = '#d1e7ff'; messageEl.style.marginLeft = 'auto'; messageEl.style.textAlign = 'right'; }
                else { messageEl.style.backgroundColor = '#e2e3e5'; messageEl.style.marginRight = 'auto'; messageEl.style.textAlign = 'left'; }
                messageEl.textContent = text;
                chatMessages.appendChild(messageEl);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function toMediaUrl(projectRelativePath) {
                if (!projectRelativePath) return '';
                const trimmed = projectRelativePath.replace(/^\.\//, '');
                if (trimmed.startsWith('asset/')) { return '/media/' + trimmed; }
                return projectRelativePath;
            }
            function setAudioSrc(src) { if (!src) return; previewAudio.src = src; previewAudio.load(); }
            function setVideoSrc(src) { if (!src) return; previewVideo.src = src; previewVideo.load(); }
            function capitalizeFirst(s) { s = (s || '').toString(); return s ? s.charAt(0).toUpperCase() + s.slice(1) : s; }

            function populateSpeakers() {
                const keys = Object.keys(speakerProfiles || {});
                targetSpeakerEl.innerHTML = '';
                keys.forEach(k => {
                    const opt = document.createElement('option');
                    const keyLower = k.toLowerCase();
                    opt.value = keyLower;
                    opt.textContent = capitalizeFirst(keyLower);
                    targetSpeakerEl.appendChild(opt);
                });
                if (!targetSpeakerEl.value) {
                    const firstOpt = targetSpeakerEl.querySelector('option');
                    if (firstOpt) targetSpeakerEl.value = firstOpt.value;
                }
            }

            function setSpeakerPreviewVideo() {
                if (!speakerProfiles) return;
                const key = (targetSpeakerEl.value || '').toLowerCase();
                const profile = speakerProfiles[key];
                if (!profile || !profile.video) return;
                const v = toMediaUrl(profile.video);
                outputVideoPathEl.value = v;
                setVideoSrc(v);
            }

            function updateFromSpeaker(resetVideo) {
                if (!speakerProfiles) return;
                const key = (targetSpeakerEl.value || '').toLowerCase();
                const profile = speakerProfiles[key];
                if (!profile) return;
                if (profile.wav) { const a = toMediaUrl(profile.wav); setAudioSrc(a); }
                if (resetVideo) { hasGeneratedVideo = false; setSpeakerPreviewVideo(); }
            }

            // Populate speakers after /config/speakers loads
            fetch('/config/speakers')
                .then(res => res.json())
                .then(data => {
                    speakerProfiles = data || {};
                    populateSpeakers();
                    setSpeakerPreviewVideo();
                    updateFromSpeaker(false);
                })
                .catch(err => console.error('Failed to load speaker profiles', err));
            targetSpeakerEl.addEventListener('change', function(){ updateFromSpeaker(true); });

            sendChatBtn.addEventListener('click', function() {
                const message = (chatInput.value || '').trim();
                if (!message) { alert('请输入聊天内容'); return; }
                appendMessage('user', message);
                chatInput.value = '';
                fetch("{{ url_for('ai_response') }}", {
                    method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: new URLSearchParams({ message })
                })
                .then(res => res.json())
                .then(data => {
                    const reply = (data && data.reply) ? data.reply : '抱歉，我无法回答这个问题。';
                    lastAiReply = reply; appendMessage('ai', reply); synthesisTextEl.value = reply;
                })
                .catch(() => appendMessage('ai', '网络错误，请稍后重试。'));
            });

            generateAudioBtn.addEventListener('click', function() {
                const text = (synthesisTextEl.value || '').trim(); const speaker = (targetSpeakerEl.value || '').trim();
                if (!text) { alert('请输入要合成的文本'); return; } if (!speaker) { alert('请选择目标演讲者'); return; }
                fetch("{{ url_for('generate') }}", {
                    method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: new URLSearchParams({ input_text: text, target_speaker: speaker })
                })
                .then(res => res.json())
                .then(data => { if (data && data.status === 'success' && data.output_path) { outputWavePathEl.value = data.output_path; setAudioSrc(data.output_path); } else { alert(data && data.message ? data.message : '音频生成失败'); } })
                .catch(() => alert('音频生成失败'));
            });

            generateVideoBtn.addEventListener('click', function() {
                const audioPath = (outputWavePathEl.value || '').trim(); const speaker = (targetSpeakerEl.value || '').trim();
                if (!audioPath) { alert('请先生成或填写音频地址'); return; } if (!speaker) { alert('请选择目标演讲者'); return; }
                fetch('/api/extract_ds_features', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: new URLSearchParams({ audio_path: audioPath }) })
                .then(res => res.json())
                .then(data => { if (!(data && data.status === 'success' && data.npy_path)) { throw new Error(data && data.message ? data.message : '特征提取失败'); }
                    return fetch('/api/generate_video', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: new URLSearchParams({ speaker: speaker, npy_path: data.npy_path }) });
                })
                .then(res => res.json())
                .then(data => { if (data && data.status === 'success' && data.video_path) { hasGeneratedVideo = true; outputVideoPathEl.value = data.video_path; setVideoSrc(data.video_path); } else { alert(data && data.message ? data.message : '视频生成失败'); } })
                .catch(err => { console.error(err); alert('视频生成失败'); });
            });

            // Play both video and audio from start, no loop, and log paths
            playVideoBtn.addEventListener('click', function() {
                const vsrc = (outputVideoPathEl.value || '').trim();
                const wsrc = (outputWavePathEl.value || '').trim();
                console.log('Play requested with video:', vsrc, 'audio:', wsrc);
                if (!vsrc) { alert('请先填写输出视频地址'); return; }
                setVideoSrc(vsrc);
                previewVideo.loop = false;
                previewVideo.muted = false;
                try { previewVideo.currentTime = 0; } catch (_) {}
                // Always reload audio from the field if provided
                if (wsrc) { setAudioSrc(wsrc); }
                try { previewAudio.currentTime = 0; } catch (_) {}
                previewVideo.play().catch((e) => { console.warn('Video play error:', e); });
                previewAudio.play().catch((e) => { console.warn('Audio play error:', e); });
            });
        })();
    </script>
</body>

</html>